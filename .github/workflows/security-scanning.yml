name: Security Scanning

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  NODE_VERSION: '18'
  AWS_REGION: us-east-1

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Gitleaks Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

  dependency-scanning:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'apps/api-handler/package-lock.json'

      - name: Install dependencies
        run: |
          cd apps/api-handler
          npm ci

      - name: Run npm audit
        run: |
          cd apps/api-handler
          npm audit --audit-level=moderate || true

      - name: Run Snyk vulnerability scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=apps/api-handler/package.json
        continue-on-error: true

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif
        continue-on-error: true

  terraform-security:
    name: Terraform Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: 'infrastructure'
          format: 'sarif'
          out_dir: 'tfsec-results'
        continue-on-error: true

      - name: Upload tfsec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: tfsec-results/tfsec.sarif
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
        continue-on-error: true

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  code-scanning:
    name: Code Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: 'javascript'

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  hardcoded-secrets-check:
    name: Hardcoded Secrets Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for AWS credentials
        run: |
          echo "Checking for hardcoded AWS credentials..."
          if grep -r "AKIA" . --include="*.js" --include="*.ts" --include="*.tf" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "ERROR: Found potential AWS access keys"
            exit 1
          fi
          echo "✓ No AWS access keys found"

      - name: Check for AWS secret keys
        run: |
          echo "Checking for hardcoded AWS secret keys..."
          if grep -r "aws_secret_access_key" . --include="*.js" --include="*.ts" --include="*.tf" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "ERROR: Found hardcoded AWS secret keys"
            exit 1
          fi
          echo "✓ No hardcoded AWS secret keys found"

      - name: Check for API keys
        run: |
          echo "Checking for hardcoded API keys..."
          if grep -rE "(api[_-]?key|apikey|api_secret|secret_key)" . --include="*.js" --include="*.ts" --include="*.tf" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git | grep -v "node_modules" | grep -v ".git" | grep -v "test" | grep -v "mock"; then
            echo "WARNING: Found potential API keys (review manually)"
          fi
          echo "✓ API key check complete"

      - name: Check for database credentials
        run: |
          echo "Checking for hardcoded database credentials..."
          if grep -rE "(password|passwd|pwd|db_password)" . --include="*.js" --include="*.ts" --include="*.tf" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git | grep -v "node_modules" | grep -v ".git" | grep -v "test" | grep -v "mock" | grep -v "placeholder"; then
            echo "WARNING: Found potential database credentials (review manually)"
          fi
          echo "✓ Database credential check complete"

      - name: Check for private keys
        run: |
          echo "Checking for private keys..."
          if grep -r "BEGIN PRIVATE KEY\|BEGIN RSA PRIVATE KEY\|BEGIN EC PRIVATE KEY" . --include="*.js" --include="*.ts" --include="*.tf" --include="*.json" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "ERROR: Found private keys"
            exit 1
          fi
          echo "✓ No private keys found"

  https-enforcement-check:
    name: HTTPS Enforcement Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API Gateway HTTPS enforcement
        run: |
          echo "Checking API Gateway configuration for HTTPS enforcement..."
          if grep -r "http://" infrastructure/modules/api_gateway/ --include="*.tf"; then
            echo "WARNING: Found HTTP references in API Gateway (should use HTTPS)"
          fi
          if grep -r "protocol = \"HTTP\"" infrastructure/modules/api_gateway/ --include="*.tf"; then
            echo "ERROR: Found HTTP protocol in API Gateway"
            exit 1
          fi
          echo "✓ API Gateway HTTPS enforcement verified"

      - name: Check Lambda environment variables
        run: |
          echo "Checking Lambda environment variables for sensitive data..."
          if grep -r "password\|secret\|key\|token" infrastructure/modules/lambda/ --include="*.tf" | grep -v "environment_variables\|description"; then
            echo "WARNING: Found potential sensitive data in Lambda configuration"
          fi
          echo "✓ Lambda environment check complete"

      - name: Check Terraform variables for hardcoded values
        run: |
          echo "Checking Terraform variables for hardcoded sensitive values..."
          if grep -r "default.*=.*['\"].*[a-zA-Z0-9]\{20,\}['\"]" infrastructure/ --include="*.tf"; then
            echo "WARNING: Found potential hardcoded values in Terraform"
          fi
          echo "✓ Terraform variable check complete"

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, terraform-security, code-scanning, hardcoded-secrets-check, https-enforcement-check]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate security report
        run: |
          echo "# Security Scanning Report" > security-report.md
          echo "" >> security-report.md
          echo "## Scan Results" >> security-report.md
          echo "" >> security-report.md
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> security-report.md
          echo "- Dependency Scanning: ${{ needs.dependency-scanning.result }}" >> security-report.md
          echo "- Terraform Security: ${{ needs.terraform-security.result }}" >> security-report.md
          echo "- Code Scanning: ${{ needs.code-scanning.result }}" >> security-report.md
          echo "- Hardcoded Secrets Check: ${{ needs.hardcoded-secrets-check.result }}" >> security-report.md
          echo "- HTTPS Enforcement Check: ${{ needs.https-enforcement-check.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "" >> security-report.md
          echo "1. Review all security scan results in GitHub Security tab" >> security-report.md
          echo "2. Address any critical or high-severity vulnerabilities" >> security-report.md
          echo "3. Ensure all secrets are stored in GitHub Actions Secrets" >> security-report.md
          echo "4. Verify HTTPS is enforced for all API communications" >> security-report.md
          echo "5. Keep dependencies up to date" >> security-report.md
          echo "" >> security-report.md
          echo "Generated: $(date)" >> security-report.md
          cat security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

      - name: Comment on PR with security report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if any critical scans failed
        if: |
          needs.secret-scanning.result == 'failure' ||
          needs.hardcoded-secrets-check.result == 'failure' ||
          needs.https-enforcement-check.result == 'failure'
        run: |
          echo "Security scanning failed - critical issues detected"
          exit 1
